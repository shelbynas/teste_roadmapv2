<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Study App - Prot√≥tipo Groq</title>
    <style>
        :root {
            --color-primary: #38bdf8; /* Tailwind Sky 400 */
            --color-secondary: #0f172a; /* Tailwind Slate 900 */
            --color-background: #f8fafc; /* Tailwind Slate 50 */
            --color-card: #ffffff;
            --color-text: #1f2937; /* Tailwind Gray 800 */
            --color-success: #10b981; /* Tailwind Green 500 */
            --color-error: #ef4444; /* Tailwind Red 500 */
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--color-background);
            color: var(--color-text);
            line-height: 1.6;
        }
        #welcome-screen, #explanation-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            text-align: center;
            padding: 20px;
        }
        #main-app {
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }
        h1 {
            color: var(--color-secondary);
            font-size: 2.5em;
            margin-bottom: 20px;
        }
        h2 {
            font-size: 1.5em;
            color: var(--color-secondary);
            border-bottom: 2px solid var(--color-primary);
            padding-bottom: 10px;
            margin-top: 30px;
        }
        .input-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        input[type="text"], select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 1em;
        }
        button, .bloco {
            display: block;
            width: 100%;
            padding: 15px;
            margin-top: 10px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .btn-primary {
            background-color: var(--color-primary);
            color: var(--color-card);
        }
        .btn-secondary {
            background-color: #e5e7eb; /* Tailwind Gray 200 */
            color: var(--color-text);
        }
        button:hover {
            opacity: 0.9;
        }
        /* ROADMAP STYLES */
        #roadmap {
            margin-top: 30px;
        }
        .bloco {
            background-color: var(--color-card);
            border: 1px solid #e5e7eb;
            color: var(--color-text);
            text-align: left;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .bloco:hover {
            background-color: #f3f4f6;
        }

        /* MODAL STYLES */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: var(--color-background); /* Fundo claro para mobile */
            padding-top: 20px;
        }
        .modal-content {
            background-color: var(--color-card);
            margin: 0 auto;
            padding: 20px;
            border-radius: 0;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            overflow-y: auto;
        }
        .modal-content h3 {
            color: var(--color-secondary);
            margin-top: 20px;
            font-size: 1.3em;
        }
        .modal-actions {
            margin-top: 20px;
            padding-bottom: 30px;
        }

        /* T√ìPICOS DENTRO DO MODAL */
        .topico-bloco {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .material-btn {
            flex: 2; /* Ocupa mais espa√ßo */
            padding: 10px;
            text-align: center;
            font-weight: 600;
        }
        .btn-simulado {
            flex: 1; /* Ocupa menos espa√ßo */
            background-color: #f97316; /* Tailwind Orange 500 */
            color: var(--color-card);
            padding: 10px;
        }

        /* SIMULADO STYLES */
        .simulado-area ul {
            list-style: none;
            padding: 0;
        }
        .alternativa {
            padding: 10px;
            margin-bottom: 8px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            background-color: #f9fafb;
            cursor: pointer;
        }
        .alternativa[data-correta="true"] {
            background-color: #d4edda; /* Verde claro */
            color: #155724;
            font-weight: bold;
        }
        .alternativa.incorreta {
            background-color: #f8d7da; /* Vermelho claro */
        }
        .btnVerResposta {
            background-color: #3b82f6;
            color: white;
            padding: 8px;
            font-size: 0.9em;
            width: auto;
            margin-top: 0;
            display: inline-block;
        }

        /* CHAT DRAWER STYLES */
        #chat-drawer {
            position: fixed;
            bottom: 0;
            right: 0;
            width: 100%;
            height: 0; /* Come√ßa escondido */
            background-color: var(--color-card);
            z-index: 2000;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.1);
            transition: height 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
        }
        #chat-drawer.open {
            height: 80%; /* Altura para mobile */
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
        }
        .chat-header {
            padding: 15px 20px;
            background-color: var(--color-secondary);
            color: var(--color-card);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
        }
        .chat-header button {
            width: auto;
            padding: 5px 10px;
            margin: 0;
            background-color: transparent;
            color: var(--color-card);
            font-size: 1.5em;
        }
        .chat-body {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
        }
        .chat-input-area {
            padding: 10px 20px;
            border-top: 1px solid #ccc;
            display: flex;
        }
        #chat-input {
            flex-grow: 1;
            margin-right: 10px;
            border-radius: 20px;
        }
        #btnEnviarChat {
            width: auto;
            padding: 10px 15px;
            margin: 0;
            border-radius: 20px;
        }

        /* CHAT BUBBLES */
        .message {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 15px;
            max-width: 80%;
            font-size: 0.9em;
        }
        .user-message {
            background-color: #e0f2fe; /* Light Blue */
            margin-left: auto;
            text-align: right;
        }
        .ai-message {
            background-color: #f3f4f6; /* Light Gray */
            margin-right: auto;
            text-align: left;
        }

        /* CHAT BUTTON FLOATER */
        #btnOpenChat {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--color-success);
            color: var(--color-card);
            font-size: 1.5em;
            line-height: 60px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1500;
            border: none;
            display: none; /* S√≥ aparece quando o roadmap for gerado */
        }
    </style>
</head>
<body>

    <div id="welcome-screen">
        <h1>Bem-vindo ao AI Study App!</h1>
        <p>Acelere seu aprendizado com Roadmaps, Simulados e um Tutor IA dedicado. Clique para come√ßar!</p>
        <button id="btnWelcomeContinue" class="btn-primary">Continuar</button>
    </div>

    <div id="explanation-screen">
        <h1>Como Funciona</h1>
        <p>1. **Gere o Roadmap:** Defina o tema e n√≠vel para criar sua trilha de estudo.</p>
        <p>2. **Estude e Pratique:** Clique nas etapas para ver o material e gerar simulados.</p>
        <p>3. **Tire D√∫vidas:** Use o chat dedicado para perguntas sobre o t√≥pico que est√° estudando. Boa jornada!</p>
        <button id="btnExplanationContinue" class="btn-primary">Entendi, Iniciar App</button>
    </div>

    <div id="main-app">
        <h1>üõ†Ô∏è Gerador de Roadmap</h1>

        <div class="input-group">
            <label for="tema">Tema de Estudo (Ex: React Hooks, Python Data Science, Hist√≥ria Antiga)</label>
            <input type="text" id="tema" value="Fundamentos de Python para Web">
        </div>

        <div class="input-group">
            <label for="nivel">N√≠vel</label>
            <select id="nivel">
                <option value="iniciante">Iniciante</option>
                <option value="intermediario">Intermedi√°rio</option>
                <option value="avancado">Avan√ßado</option>
            </select>
        </div>

        <div class="input-group">
            <label for="objetivo">Objetivo (Opcional)</label>
            <input type="text" id="objetivo" value="Criar um backend simples com Flask">
        </div>

        <button id="btnGerar" class="btn-primary">‚ú® Gerar Trilha de Estudos</button>

        <h2>Trilha Gerada</h2>
        <div id="roadmap">
            <p>Aguardando a gera√ß√£o do seu roadmap...</p>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-titulo"></h2>
            <div id="modal-conteudo">
                </div>
        </div>
    </div>

    <button id="btnOpenChat" title="Chat de D√∫vidas"></button>

    <div id="chat-drawer">
        <div class="chat-header">
            <span id="chat-topic-title">Tutor IA:</span>
            <button onclick="closeChatDrawer()">X</button>
        </div>
        <div class="chat-body" id="chat-body">
            <div class="ai-message message">Ol√°! Eu sou seu tutor IA. Posso te ajudar com d√∫vidas sobre o t√≥pico que voc√™ est√° estudando. Qual sua d√∫vida?</div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="chat-input" placeholder="Pergunte aqui...">
            <button id="btnEnviarChat" class="btn-primary">Enviar</button>
        </div>
    </div>

    <script>
        // ===================================================
        // VARI√ÅVEIS DE CONFIGURA√á√ÉO
        // ===================================================
        const API_KEY = "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"; // ‚¨ÖÔ∏è SUBSTITUA PELA SUA CHAVE
        const GROQ_ENDPOINT = "https://api.groq.com/openai/v1/chat/completions";
        const MODEL_NAME = "llama-3.1-8b-instant";

        let modalState = {};
        let currentTopicContext = "Fundamentos de Estudos"; // Contexto inicial para o chat

        // --- CONTROLE DE FLUXO DA INTERFACE ---

        document.addEventListener("DOMContentLoaded", () => {
            // Esconde todas as telas e mostra a primeira
            document.getElementById("explanation-screen").style.display = 'none';
            document.getElementById("main-app").style.display = 'none';
            document.getElementById("welcome-screen").style.display = 'flex';

            // Transi√ß√µes de tela
            document.getElementById("btnWelcomeContinue").addEventListener("click", showExplanationScreen);
            document.getElementById("btnExplanationContinue").addEventListener("click", showMainApp);

            // Listeners principais
            document.getElementById("btnGerar").addEventListener("click", gerarRoadmap);

            // Listeners do Chat
            document.getElementById("btnOpenChat").innerText = 'üí¨'; // √çcone para mobile
            document.getElementById("btnOpenChat").addEventListener("click", openChatDrawer);
            document.getElementById("btnEnviarChat").addEventListener("click", handleChatSubmit);

            // Permitir Enter para enviar no chat
            document.getElementById("chat-input").addEventListener("keypress", (e) => {
                if (e.key === 'Enter') {
                    handleChatSubmit();
                }
            });
        });

        function showExplanationScreen() {
            document.getElementById("welcome-screen").style.display = 'none';
            document.getElementById("explanation-screen").style.display = 'flex';
        }

        function showMainApp() {
            document.getElementById("explanation-screen").style.display = 'none';
            document.getElementById("main-app").style.display = 'block';
        }

        // --- L√ìGICA DO ROADMAP E SIMULADO (A PARTIR DO C√ìDIGO DO USU√ÅRIO) ---

        // 1. FUN√á√ÉO PRINCIPAL: GERAR ROADMAP
        async function gerarRoadmap() {
            const tema = document.getElementById("tema").value;
            const nivel = document.getElementById("nivel").value;
            const objetivo = document.getElementById("objetivo").value;
            const roadmapDiv = document.getElementById("roadmap");
            roadmapDiv.innerHTML = "‚ú® Gerando roadmap...";
            document.getElementById("btnOpenChat").style.display = 'none'; // Esconde chat at√© gerar

            if (!tema || API_KEY === "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") {
                roadmapDiv.innerHTML = "‚ö†Ô∏è Por favor, preencha o Tema e substitua a API_KEY no c√≥digo.";
                return;
            }

            // üí° ATUALIZA O CONTEXTO PRINCIPAL DA TRILHA
            currentTopicContext = tema;
            document.getElementById("chat-topic-title").innerText = `Tutor IA: ${tema}`;

            try {
                const systemPrompt = `Voc√™ √© um especialista em educa√ß√£o t√©cnica. Crie um roadmap detalhado com **no m√≠nimo 8 (oito) etapas obrigat√≥rias**. Cada t√≥pico deve ser ultra espec√≠fico e **DEVE incluir uma URL de documenta√ß√£o oficial ou tutorial renomado** no campo 'material'. Sua √∫nica resposta deve ser APENAS JSON v√°lido, sem texto introdut√≥rio ou blocos de c√≥digo markdown. O JSON deve seguir este formato: {"etapas": [{"titulo": "Etapa 1: Nome da etapa", "topicos": [{"t√≥pico": "Nome do t√≥pico", "material": "URL de uma fonte externa"}], "atividade": "Descri√ß√£o da atividade pr√°tica"}]}.`;
                const userPrompt = `Crie um roadmap de estudos detalhado e abrangente para o tema "${tema}" no n√≠vel "${nivel}"${objetivo ? ` com objetivo "${objetivo}"` : ""}. Inclua fontes externas de estudo no campo 'material' para todos os t√≥picos.`;

                const response = await fetch(GROQ_ENDPOINT, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${API_KEY}` },
                    body: JSON.stringify({
                        model: MODEL_NAME,
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: userPrompt }
                        ],
                        response_format: { type: "json_object" },
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Erro API: ${response.status} - ${errorData.error.message}`);
                }

                const data = await response.json();
                let texto = data.choices?.[0]?.message?.content || "";
                let parsed = parseJsonRobustly(texto);

                const etapas = parsed.etapas;
                modalState.etapas = etapas;
                roadmapDiv.innerHTML = "";

                etapas.forEach(etapa => {
                    const blocoDiv = document.createElement("div");
                    blocoDiv.className = "bloco";
                    blocoDiv.innerText = etapa.titulo;
                    blocoDiv.onclick = () => abrirModalMateriais(etapa);
                    roadmapDiv.appendChild(blocoDiv);
                });
                document.getElementById("btnOpenChat").style.display = 'block'; // Mostra chat
            } catch (err) {
                console.error("Erro:", err);
                roadmapDiv.innerHTML = `‚ö†Ô∏è Erro ao gerar roadmap. Causa: ${err.message}.`;
            }
        }

        // 2. FUN√á√ÉO: ABRIR MODAL DA ETAPA
        function abrirModalMateriais(etapa) {
            modalState.currentEtapa = etapa;
            currentTopicContext = etapa.titulo; // üí° ATUALIZA CONTEXTO PARA O CHAT
            document.getElementById("chat-topic-title").innerText = `Tutor IA: ${etapa.titulo}`;

            document.getElementById("modal").style.display = "block";
            document.getElementById("modal-titulo").innerText = etapa.titulo;

            const conteudo = etapa.topicos.map(t => {
                const topicoEscapado = t.t√≥pico.replace(/'/g,"\\'");
                const materialLink = t.material ? t.material : "";

                return `
                    <div class="topico-bloco">
                        <button class="bloco material-btn" onclick="gerarConteudoMaterial('${topicoEscapado}', '${materialLink}')">${t.t√≥pico}</button>
                        <button class="btn-simulado" onclick="gerarSimulado('${topicoEscapado}')">üß† Simulado</button>
                    </div>
                `;
            }).join("");

            document.getElementById("modal-conteudo").innerHTML = `
                <h3>üìå Atividade pr√°tica:</h3>
                <p>${etapa.atividade}</p>
                <h3>üìö T√≥picos e Simulado:</h3>
                <div class="topicos-container">${conteudo}</div>
                <div class="modal-actions">
                    <button onclick="fecharModal()" class="btn-secondary">‚ùå Fechar</button>
                </div>
            `;
        }

        // 3. FUN√á√ÉO: GERAR SIMULADO
        async function gerarSimulado(topico) {
            const modalConteudo = document.getElementById("modal-conteudo");
            modalConteudo.innerHTML = `<p>Carregando simulado sobre: <strong>${topico}</strong>...</p>`;
            currentTopicContext = topico; // üí° ATUALIZA CONTEXTO PARA O CHAT

            try {
                const systemPromptSimulado = `Voc√™ √© um gerador de quest√µes de m√∫ltipla escolha. Sua √∫nica resposta deve ser APENAS JSON v√°lido, sem texto introdut√≥rio. O JSON deve ser um objeto contendo um array de **5 perguntas**. O formato deve ser: {"simulados": [{"pergunta": "...", "alternativas": ["A) ...", "B) ...", "C) ...", "D) ...", "E) ..."], "resposta_correta": "Letra da alternativa correta (ex: C)"}, {"pergunta": "...", ...}]}.`;
                const userPromptSimulado = `Crie 5 quest√µes de m√∫ltipla escolha sobre o t√≥pico "${topico}" no n√≠vel ${document.getElementById("nivel").value}. Cada quest√£o deve ter 5 alternativas.`;

                const response = await fetch(GROQ_ENDPOINT, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${API_KEY}` },
                    body: JSON.stringify({
                        model: MODEL_NAME,
                        messages: [
                            { role: "system", content: systemPromptSimulado },
                            { role: "user", content: userPromptSimulado }
                        ],
                        response_format: { type: "json_object" },
                        temperature: 0.6
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Erro API: ${response.status} - ${errorData.error.message}`);
                }

                const data = await response.json();
                let texto = data.choices?.[0]?.message?.content || "Erro ao gerar simulado.";
                let parsedData = parseJsonRobustly(texto);

                const simulados = parsedData.simulados || [parsedData];

                const simuladosHtml = simulados.map((simulado, index) => {
                    const alternativasHtml = simulado.alternativas.map((alt) => {
                        const letra = alt.charAt(0);
                        return `<li class="alternativa"
                                        data-correta="${letra === simulado.resposta_correta.charAt(0)}">
                                        ${alt}
                                    </li>`;
                    }).join("");

                    return `
                        <div class="simulado-bloco">
                            <h4>Quest√£o ${index + 1}:</h4>
                            <p><strong>${simulado.pergunta}</strong></p>
                            <ul>${alternativasHtml}</ul>
                            <button class="btnVerResposta" onclick="mostrarResposta(this)">Ver Resposta</button>
                            <p class="feedback" style="font-weight: bold; margin-top: 10px;"></p>
                        </div>
                        <hr>
                    `;
                }).join("");

                modalConteudo.innerHTML = `
                    <h3>Simulado: ${topico}</h3>
                    <div class="simulado-area">
                        ${simuladosHtml}
                    </div>
                    <div class="modal-actions">
                        <button onclick="abrirModalMateriais(modalState.currentEtapa)" class="btn-secondary">‚¨Ö Voltar</button>
                    </div>
                `;

            } catch (err) {
                // ... (l√≥gica de erro)
            }
        }

        // 4. FUN√á√ÉO: MOSTRAR RESPOSTA DO SIMULADO (inalterada)
        function mostrarResposta(button) {
            // ... (l√≥gica do usu√°rio)
            const simuladoBloco = button.closest('.simulado-bloco');
            if (!simuladoBloco) return;

            const alternativas = simuladoBloco.querySelectorAll('.alternativa');
            const feedback = simuladoBloco.querySelector('.feedback');

            alternativas.forEach(li => {
                if (li.dataset.correta === 'true') {
                    li.style.backgroundColor = '#d4edda';
                    li.style.color = '#155724';
                } else {
                    li.classList.add('incorreta');
                }
                li.style.cursor = 'default';
            });

            button.style.display = 'none';
            if (feedback) {
                feedback.innerText = 'A resposta correta est√° destacada.';
            }
        }

        // 5. FUN√á√ÉO: GERAR CONTE√öDO MATERIAL (Explica√ß√£o Detalhada - Alto Custo)
        async function gerarConteudoMaterial(topico, material) {
            const modalConteudo = document.getElementById("modal-conteudo");
            modalConteudo.innerHTML = `<p>Carregando conte√∫do sobre: <strong>${topico}</strong>...</p>`;
            currentTopicContext = topico; // üí° ATUALIZA CONTEXTO PARA O CHAT

            try {
                // N√£o tem max_tokens aqui para permitir a resposta DETALHADA
                const userPromptMaterial = material
                    ? `Explique de forma did√°tica e detalhada o t√≥pico "${topico}" consultando o conte√∫do do link: ${material}. A sua resposta deve ser APENAS a explica√ß√£o, sem mencionar a fonte. Se o link for inacess√≠vel ou inv√°lido, gere a explica√ß√£o baseada em seu conhecimento.`
                    : `Explique de forma did√°tica e detalhada o t√≥pico "${topico}".`;

                const response = await fetch(GROQ_ENDPOINT, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${API_KEY}` },
                    body: JSON.stringify({
                        model: MODEL_NAME,
                        messages: [
                            { role: "user", content: userPromptMaterial }
                        ],
                        temperature: 0.8
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Erro API: ${response.status} - ${errorData.error.message}`);
                }

                const data = await response.json();
                let texto = data.choices?.[0]?.message?.content || "Erro ao gerar conte√∫do.";

                // ... (convers√£o de markdown para HTML)
                texto = texto.replace(/\*\*(.*?)\*\*/g, "<b>$1</b>");
                texto = texto.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');

                // ... (exibi√ß√£o de fonte)
                let sourceHtml = '';
                if (material && material !== 'null' && material.startsWith('http')) {
                    sourceHtml = `
                        <h3 style="margin-top: 30px; border-left: 5px solid var(--color-primary); padding-left: 12px;">üîó Fonte Utilizada</h3>
                        <p><a href="${material}" target="_blank">${material}</a></p>
                    `;
                }

                modalConteudo.innerHTML = `
                    <h3>${topico}</h3>
                    <div style="max-height:400px; overflow-y:auto; padding-right:10px; white-space: pre-wrap;">
                        ${texto}
                    </div>
                    ${sourceHtml}
                    <div class="modal-actions">
                        <button onclick="abrirModalMateriais(modalState.currentEtapa)" class="btn-secondary">‚¨Ö Voltar</button>
                    </div>
                `;

            } catch (err) {
                // ... (l√≥gica de erro)
            }
        }

        // 6. FUN√á√ÉO: FECHAR MODAL (inalterada)
        function fecharModal() {
            document.getElementById("modal").style.display = "none";
        }

        // --- L√ìGICA DO CHAT DE D√öVIDAS (NOVA FUN√á√ÉO - Baixo Custo) ---

        function openChatDrawer() {
            document.getElementById("chat-drawer").classList.add('open');
            document.getElementById("chat-input").focus();
            document.getElementById("btnOpenChat").style.display = 'none';
            // Garante que o t√≥pico de chat esteja sempre no t√≠tulo
            document.getElementById("chat-topic-title").innerText = `Tutor IA: ${currentTopicContext}`;
        }

        function closeChatDrawer() {
            document.getElementById("chat-drawer").classList.remove('open');
            // Mostra o bot√£o flutuante apenas se j√° tiver gerado o roadmap
            if (document.getElementById("roadmap").innerHTML.includes("bloco")) {
                document.getElementById("btnOpenChat").style.display = 'block';
            }
        }

        async function handleChatSubmit() {
            const input = document.getElementById("chat-input");
            const perguntaDoUsuario = input.value.trim();
            if (!perguntaDoUsuario) return;

            appendMessage(perguntaDoUsuario, 'user');
            input.value = ''; // Limpa o input

            await chatTiraDuvidas(perguntaDoUsuario);
        }

        /**
         * NOVA FUN√á√ÉO: Chat de D√∫vidas (Otimizada para Contexto e Custo)
         */
        async function chatTiraDuvidas(perguntaDoUsuario) {
            const chatBody = document.getElementById("chat-body");
            const tempMessageId = `temp-${Date.now()}`;

            // Mensagem de "Digitando..."
            appendMessage("...", 'ai', tempMessageId);

            // üí° CHAVE DE CUSTO: Limitar o tamanho da resposta (Sa√≠da)
            const MAX_OUTPUT_TOKENS = 250;

            // üí° CHAVE DE CONTEXTO: Enviar o t√≥pico ativo
            const systemPromptChat = `Voc√™ √© um tutor IA focado no t√≥pico: "${currentTopicContext}". Responda √† pergunta do usu√°rio de forma clara, did√°tica e direta. Sua resposta deve ter no m√°ximo 200 palavras (garantido por max_tokens). N√£o inclua nenhuma introdu√ß√£o ou despedida.`;

            try {
                const response = await fetch(GROQ_ENDPOINT, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${API_KEY}` },
                    body: JSON.stringify({
                        model: MODEL_NAME,
                        messages: [
                            { role: "system", content: systemPromptChat },
                            { role: "user", content: perguntaDoUsuario }
                        ],
                        temperature: 0.5,
                        max_tokens: MAX_OUTPUT_TOKENS // Otimiza√ß√£o de Custo!
                    })
                });

                document.getElementById(tempMessageId).remove(); // Remove o "Digitando..."

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Erro API: ${response.status} - ${errorData.error.message}`);
                }

                const data = await response.json();
                const respostaIA = data.choices?.[0]?.message?.content || "Desculpe, n√£o consegui processar sua d√∫vida.";
                appendMessage(respostaIA, 'ai');

            } catch (err) {
                document.getElementById(tempMessageId)?.remove();
                console.error("Erro no Chat:", err);
                appendMessage(`‚ö†Ô∏è Erro ao comunicar com a IA: ${err.message}.`, 'ai');
            }

            chatBody.scrollTop = chatBody.scrollHeight; // Scroll para o final
        }

        function appendMessage(text, sender, id = null) {
            const chatBody = document.getElementById("chat-body");
            const messageDiv = document.createElement("div");
            messageDiv.className = `message ${sender}-message`;
            messageDiv.innerHTML = text.replace(/\n/g, '<br>');
            if (id) messageDiv.id = id;
            chatBody.appendChild(messageDiv);
        }

        // --- UTILIT√ÅRIOS ---
        // Fun√ß√£o robusta para parsear JSON (do c√≥digo anterior)
        function parseJsonRobustly(texto) {
            let textoLimpo = texto.trim().replace(/[\u0000-\u001F\u007F-\u009F]/g, "");
            let parsed;
            try {
                parsed = JSON.parse(textoLimpo);
            } catch (e) {
                const jsonMatch = textoLimpo.match(/\{[\s\S]*\}/);
                if (!jsonMatch) {
                    throw new Error("N√£o foi poss√≠vel extrair JSON da resposta da IA.");
                }
                parsed = JSON.parse(jsonMatch[0]);
            }
            return parsed;
        }

    </script>
</body>
</html>
