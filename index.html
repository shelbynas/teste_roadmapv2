<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quackademy - Trilha de Estudos</title>
    <link rel="icon" href="favicon.ico"> 

    <style>
        /* ===================================================
        // CSS INTEGRADO (com otimizações de responsividade)
        // =================================================== */
        
        /* --- Variáveis de Cor (Paleta Amarela) --- */
        :root {
            --color-primary: #FFC107; /* Amarelo Vibrante */
            --color-primary-dark: #E0A800; /* Amarelo Escuro */
            --color-secondary: #343A40; /* Cinza Escuro para Texto */
            --color-background: #F8F9FA; /* Fundo Suave */
            --color-card: #FFFFFF;
            --color-success: #28A745;
            --color-danger: #DC3545;
            --color-light-yellow: #FFFBEA; /* Amarelo muito claro para blocos */
        }
        
        /* --- Estilos Gerais e Tipografia --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--color-background);
            color: var(--color-secondary);
            margin: 0;
            padding: 0;
            line-height: 1.6;
        }
        
        .container {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        /* --- ESTILOS DAS TELAS INICIAIS (Boas-Vindas e Explicação) --- */
        .full-screen-message {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100%;
            background-color: var(--color-background);
            text-align: center;
        }
        
        .message-card {
            background-color: var(--color-card);
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            max-width: 500px;
            width: 90%;
        }
        
        .mascote-welcome {
            width: 200px; 
            height: 200px; 
            border-radius: 0; 
            object-fit: contain;
            margin-bottom: 20px;
            border: none;
            background-color: transparent;
        }
        
        .message-card h2 {
            color: var(--color-primary-dark);
            font-size: 2.2em; 
            margin-top: 10px;
            margin-bottom: 20px;
        }
        
        /* --- Layout Principal (Header e Main) --- */
        header {
            background-color: var(--color-primary);
            color: var(--color-secondary);
            padding: 30px 0;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            position: relative; 
        }
        
        header h1 {
            margin: 0;
            font-size: 2.5em; 
            font-weight: 900;
        }
        
        header p {
            margin: 5px 0 0;
            font-size: 1.1em; 
        }
        
        main {
            padding: 20px 0; 
        }

        /* Contêiner para centralizar o formulário e gerenciar a troca de telas */
        #main-content-area {
            display: flex;
            justify-content: center;
            width: 100%; 
        }
        
        /* --- Controles (Formulário) --- */
        .controles {
            background-color: var(--color-card);
            padding: 20px; 
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            width: 100%; 
            max-width: 500px; 
            height: fit-content; 
        }

        .mascote-area {
            text-align: center;
            margin-bottom: 20px; 
            padding-bottom: 15px; 
            border-bottom: 1px solid #eee;
        }
        
        .mascote {
            width: 120px; 
            height: 120px; 
            border-radius: 8px; 
            object-fit: contain;
            margin-bottom: 10px;
            border: none;
            background-color: transparent; 
        }
        
        .controles h2 {
            color: var(--color-secondary);
            font-size: 1.4em; 
            margin-top: 0;
        }
        
        .controles label {
            display: block;
            margin-top: 20px;
            margin-bottom: 8px;
            font-weight: bold;
            color: var(--color-secondary);
            font-size: 0.95em;
        }
        
        .controles input[type="text"],
        .controles select,
        .controles textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            box-sizing: border-box; 
            resize: vertical;
            font-size: 0.95em;
            background-color: white; 
            color: var(--color-secondary);
        }
        
        .controles textarea {
            min-height: 100px;
        }
        
        /* --- Botões --- */
        .btn-primary {
            display: block;
            width: 100%;
            padding: 12px; 
            margin-top: 25px; 
            background-color: var(--color-primary);
            color: var(--color-secondary);
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
        }
        
        .btn-primary:hover {
            background-color: var(--color-primary-dark);
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            padding: 12px 18px; 
            font-size: 1em; 
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 500;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-success {
            padding: 12px 18px; 
            font-size: 1em; 
            background-color: var(--color-success);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 500;
        }
        
        .btn-success:hover {
            background-color: #1e7e34;
        }
        
        /* --- ESTILOS DAS TELAS DE CONTEÚDO (Roadmap, Etapa, Material, Simulado) --- */
        .content-view {
            width: 100%;
        }

        #roadmap-container, #etapa-container, #material-container, #flashcard-container, #simulado-etapa-container, #chat-container {
            background-color: var(--color-card);
            padding: 20px; 
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            width: 100%;
        }

        #roadmap-container h2, #etapa-container h2, #material-container h2, #flashcard-container h2, #simulado-etapa-container h2 {
            color: var(--color-primary);
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-top: 0;
            font-size: 1.6em; 
        }

        /* --- Estilos da Tela Roadmap --- */
        .roadmap-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 15px; 
            padding-top: 5px;
        }
        
        .bloco {
            flex: 1 1 100%; 
            min-width: unset;
            padding: 20px; 
            background-color: var(--color-light-yellow); 
            border: 1px solid var(--color-primary-dark);
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            font-size: 0.9em;
        }
        
        .bloco:hover {
            background-color: var(--color-primary);
            transform: translateY(-3px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.1);
        }
        
        .placeholder-text {
            color: #999;
            text-align: center;
            width: 100%;
            padding: 50px;
            font-style: italic;
        }
        
        /* --- Estilos da Tela Etapa / Tópicos --- */
        #etapa-conteudo h3 {
            color: var(--color-secondary);
            margin-top: 30px;
            border-left: 5px solid var(--color-primary);
            padding-left: 12px;
        }

        .topicos-container {
            margin-top: 20px;
        }
        
        .topico-bloco {
            display: flex;
            flex-direction: column; 
            gap: 10px;
            margin-bottom: 15px;
            align-items: stretch;
        }
        
        .material-btn {
            flex: 1; 
            padding: 10px 15px;
            background-color: #F0F0F0;
            border: 1px solid #ddd;
            color: var(--color-secondary);
            cursor: pointer;
            text-align: left; 
            font-weight: 500;
            transition: background-color 0.1s;
            box-shadow: none; 
            min-width: unset;
            font-size: 0.9em;
            border-radius: 6px; 
            text-decoration: none; 
            display: block;
        }
        
        .material-btn:hover {
            background-color: #E0E0E0;
        }

        /* Novo Botão para Flashcards */
        .btn-flashcard {
            flex: 1;
            background-color: #007bff; /* Azul */
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: bold;
            min-width: unset;
            font-size: 0.9em;
        }
        
        .btn-flashcard:hover {
            background-color: #0056b3;
        }

        /* Botão de Simulado da Etapa */
        .btn-simulado-etapa {
            width: 100%;
            margin-top: 20px;
            background-color: var(--color-secondary);
            color: white;
            padding: 15px;
            font-size: 1.1em;
        }
        .btn-simulado-etapa:hover {
            background-color: #212529;
        }
        
        .modal-actions {
            text-align: center; 
            margin-top: 20px;
        }
        .modal-actions button {
            width: 100%;
        }
        
        /* --- Estilos da Tela Flashcard --- */
        #flashcard-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }

        .flashcard {
            width: 100%;
            max-width: 400px;
            height: 250px;
            perspective: 1000px;
            margin-bottom: 20px;
        }

        .flashcard-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        .flashcard.flipped .flashcard-inner {
            transform: rotateY(180deg);
        }

        .flashcard-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            font-size: 1.1em;
            font-weight: 500;
        }

        .flashcard-front {
            background-color: var(--color-primary);
            color: var(--color-secondary);
            border: 2px solid var(--color-primary-dark);
        }

        .flashcard-back {
            background-color: #F0F0F0;
            color: var(--color-secondary);
            border: 2px solid #ddd;
            transform: rotateY(180deg);
            text-align: left;
        }

        .flashcard-navigation {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 400px;
        }
        
        /* --- Estilos da Tela Simulado (Etapa) --- */
        .simulado-area ul {
            list-style: none;
            padding: 0;
            margin-top: 15px;
        }
        
        .simulado-area li.alternativa {
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            transition: background-color 0.3s;
            cursor: pointer; 
            background-color: var(--color-card); 
            color: var(--color-secondary);
        }
        
        .simulado-area li.alternativa:hover {
             background-color: #f8f9fa;
        }
        
        .simulado-area li.selected {
            background-color: var(--color-primary) !important; 
            border-color: var(--color-primary-dark) !important;
        }

        .simulado-area li.incorreta {
            background-color: #FFF3F3 !important; 
            color: var(--color-danger) !important;
            border-color: #F5C6CB !important;
        }
        
        .simulado-area li.correta-destacada {
            background-color: #d4edda !important; 
            color: #155724 !important;
            border-color: #c3e6cb !important;
        }

        .simulado-bloco {
            margin-bottom: 25px;
            padding: 20px 0;
        }
        
        .simulado-area hr {
            margin-top: 25px;
            margin-bottom: 25px;
            border-top: 1px solid #eee;
        }

        #simulado-resultado {
            padding: 20px;
            background-color: var(--color-light-yellow);
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
            border: 2px solid var(--color-primary);
            font-size: 1.1em;
            font-weight: bold;
        }
        
        /* --- Estilos do Chatbot Patolindo --- */
        
        #chat-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--color-primary-dark);
            color: var(--color-secondary);
            font-size: 2em;
            font-weight: bold;
            border: 3px solid var(--color-primary);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: background-color 0.2s;
            z-index: 1000;
            display: none; 
        }

        #chat-button:hover {
            background-color: var(--color-primary);
        }

        #chat-container {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 120px); 
            min-height: 450px;
            background-color: var(--color-card);
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.1);
        }

        #chat-header-view {
            background-color: var(--color-primary);
            color: var(--color-secondary);
            padding: 15px 20px;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.2em;
        }
        
        /* ---------------------------------------------------
        * MEDIA QUERIES OTIMIZADAS
        * --------------------------------------------------- */
        
        /* Tablet (Telas maiores que 601px) */
        @media (min-width: 601px) {
            .bloco {
                flex: 1 1 calc(50% - 15px); 
                font-size: 1em;
            }
        
            .topico-bloco {
                display: flex;
                flex-direction: row; 
                gap: 15px;
            }
        
            .modal-actions {
                text-align: right;
            }
            .modal-actions button {
                width: auto; 
            }
            
            /* Ajuste dos botões de tópico */
            .material-btn, .btn-flashcard {
                flex: 1 1 50%; 
            }
            .topico-bloco {
                justify-content: space-between;
            }
        }
        
        /* Desktop (Telas maiores que 993px) */
        @media (min-width: 993px) {
            .bloco {
                flex: 1 1 calc(33.333% - 20px); 
                padding: 25px;
            }
        }
    </style>
</head>
<body>

    <section id="welcome-screen" class="full-screen-message">
        <div class="message-card">
            <img src="mascote_inicial.png" alt="Mascote Quackademy, o Pato" class="mascote-welcome">
            
            <h2>🦆 Bem-vindo ao Quackademy! </h2>
            <p>Pare de se afogar em tutoriais soltos. Nós transformamos o caos do aprendizado online em uma <strong>trilha de estudos estruturada e à prova de procrastinação</strong>.</p>
            <button id="btnWelcomeContinue" class="btn-primary">Descubra como</button>
        </div>
    </section>

    <section id="explanation-screen" class="full-screen-message" style="display: none;">
        <div class="message-card">
            <h2>Sua Jornada de Aprendizado Personalizada</h2>
            <div style="text-align: left; margin: 20px 0;">
                
                <h3>🧠 O Nosso Propósito</h3>
                <p>
                    A <strong>Quackademy</strong> foi criada para você que está cansado de apenas copiar e colar. Usamos a IA para criar um plano de estudos único, focado em <strong>atividades práticas</strong> e no <strong>entendimento real</strong>.
                </p>
                
                <h3>⚙️ Como Funciona Nossa Trilha</h3>
                <ul>
                    <li><strong>Trilhas Guiadas:</strong> Você informa o tema e o nível, e nossa IA gera um plano de <strong>8 Etapas</strong> personalizadas.</li>
                    <li><strong>Flashcards:</strong> Use **flashcards por tópico** para memorizar conceitos chave rapidamente.</li>
                    <li><strong>Simulado de Etapa:</strong> Faça um **simulado completo por etapa** (20+ questões) para testar sua aplicação do conteúdo.</li>
                </ul>
            </div>
            <button id="btnExplanationContinue" class="btn-primary">Começar Minha Trilha 🚀</button>
        </div>
    </section>

    <div id="main-app" style="display: none;">
        <header>
            <div class="container">
                <h1>Quackademy Trilha de Estudos</h1>
                <p>O seu guia para o aprendizado acelerado e estruturado.</p>
            </div>
        </header>

        <main class="container">
            <div id="main-content-area">
                
                <div id="form-view" class="content-view">
                    <div class="controles">
                        <div class="mascote-area">
                             <img src="mascote.png" alt="Mascote Quackademy" class="mascote">
                            <h2>Defina seu Desafio</h2>
                        </div>
                        
                        <label for="tema">Tema ou Tecnologia:</label>
                        <input type="text" id="tema" placeholder="Ex: Programação Python, Cloud Computing, etc." required>
                        
                        <label for="nivel">Nível de Dificuldade:</label>
                        <select id="nivel">
                            <option value="Iniciante">Iniciante</option>
                            <option value="Intermediário">Intermediário</option>
                            <option value="Avançado">Avançado</option>
                        </select>
                        
                        <label for="objetivo">Objetivo Específico (Opcional):</label>
                        <textarea id="objetivo" placeholder="Ex: Aprender a criar um backend com Node.js e Express."></textarea>
                        
                        <button id="btnGerar" class="btn-primary">Gerar Trilha 🚀</button>
                    </div>
                </div>

                <div id="roadmap-view" class="content-view" style="display: none;">
                    <div id="roadmap-container">
                        <h2>Sua Trilha de Estudos</h2>
                        <div id="roadmap" class="roadmap-grid">
                            <p class="placeholder-text">Preencha o formulário e gere sua primeira trilha!</p>
                        </div>
                        <div class="modal-actions" style="text-align: right;">
                             <button onclick="showFormView()" class="btn-secondary" style="width: auto;">⬅ Nova Trilha / Alterar Tema</button>
                        </div>
                    </div>
                </div>
                
                <div id="etapa-view" class="content-view" style="display: none;">
                    <div id="etapa-container">
                        <h2 id="etapa-titulo"></h2>
                        <div id="etapa-conteudo"></div>
                        <div class="modal-actions">
                            <button onclick="showRoadmapView()" class="btn-secondary">⬅ Voltar à Trilha</button>
                        </div>
                    </div>
                </div>

                <div id="material-view" class="content-view" style="display: none;">
                    <div id="material-container">
                        <h2 id="material-titulo"></h2>
                        <div id="material-conteudo"></div>
                        <div class="modal-actions">
                            <button id="btnMaterialVoltar" class="btn-secondary">⬅ Voltar à Etapa</button>
                        </div>
                    </div>
                </div>

                <div id="flashcard-view" class="content-view" style="display: none;">
                    <div id="flashcard-container">
                        <h2 id="flashcard-titulo"></h2>
                        <div id="flashcard-display">
                            </div>
                        <div class="modal-actions">
                            <button id="btnFlashcardVoltar" class="btn-secondary">⬅ Voltar à Etapa</button>
                        </div>
                    </div>
                </div>

                <div id="simulado-etapa-view" class="content-view" style="display: none;">
                    <div id="simulado-etapa-container">
                        <h2 id="simulado-etapa-titulo"></h2>
                        <div id="simulado-etapa-conteudo">
                            </div>
                        <div id="simulado-etapa-botoes" class="modal-actions">
                            </div>
                        <div class="modal-actions">
                            <button id="btnSimuladoEtapaVoltar" class="btn-secondary">⬅ Voltar à Etapa</button>
                        </div>
                    </div>
                </div>

                <div id="chat-view" class="content-view" style="display: none;">
                    <div id="chat-container">
                        <div id="chat-header-view">
                            Patolindo - Seu Assistente de Estudos <span id="chat-counter">(5 Perguntas)</span>
                        </div>
                        <div id="chat-messages">
                            </div>
                        <div id="chat-input-area">
                            <input type="text" id="chat-input" placeholder="Sua pergunta..." disabled>
                            <button id="chat-send-button" disabled>Enviar</button>
                        </div>
                        <div class="modal-actions" style="border-top: 1px solid #eee; padding-top: 15px;">
                            <button id="chat-exit-button" class="btn-secondary">⬅ Sair do Chat</button>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <button id="chat-button" title="Abrir Chatbot Patolindo">
        🦆
    </button>


    <script>
        // ===================================================
        // JAVASCRIPT INTEGRADO (script.js)
        // ===================================================

        // ⚠️ CHAVE API INSERIDA AUTOMATICAMENTE ⚠️
        const API_KEY = "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"; 
        
        const GROQ_ENDPOINT = "https://api.groq.com/openai/v1/chat/completions";
        const MODEL_NAME = "llama-3.1-8b-instant"; 

        let modalState = {}; 
        let patolindoState = {
            questionsLeft: 5,
            history: [],
            lastView: "roadmap-view" 
        };
        
        let currentTheme = ""; 

        // --- CONTROLE DE FLUXO DA INTERFACE ---

        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById("explanation-screen").style.display = 'none';
            document.getElementById("main-app").style.display = 'none';
            document.getElementById("welcome-screen").style.display = 'flex'; 

            document.getElementById("btnWelcomeContinue").addEventListener("click", showExplanationScreen);
            document.getElementById("btnExplanationContinue").addEventListener("click", showMainApp);
            
            document.getElementById("btnGerar").addEventListener("click", gerarRoadmap);
            
            // Listeners dos botões de voltar (dentro das telas de conteúdo)
            document.getElementById("btnMaterialVoltar").addEventListener("click", () => showEtapaView(modalState.currentEtapa));
            document.getElementById("btnFlashcardVoltar").addEventListener("click", () => showEtapaView(modalState.currentEtapa));
            document.getElementById("btnSimuladoEtapaVoltar").addEventListener("click", () => showEtapaView(modalState.currentEtapa));
            
            // --- Listeners do Chatbot ---
            document.getElementById("chat-button").addEventListener("click", () => showChatView(patolindoState.lastView));
            document.getElementById("chat-exit-button").addEventListener("click", () => showLastView());
            document.getElementById("chat-send-button").addEventListener("click", handleChatSend);
            document.getElementById("chat-input").addEventListener("keypress", (e) => {
                if (e.key === 'Enter') handleChatSend();
            });
            document.getElementById("chat-input").addEventListener("input", updateSendButtonState);
        });

        // Funções de transição de telas iniciais
        function showExplanationScreen() {
            document.getElementById("welcome-screen").style.display = 'none';
            document.getElementById("explanation-screen").style.display = 'flex';
        }

        function showMainApp() {
            document.getElementById("explanation-screen").style.display = 'none';
            document.getElementById("main-app").style.display = 'block';
            showFormView(); 
        }

        // --- LÓGICA DE NAVEGAÇÃO SPA ---

        const viewMap = {
            "form-view": document.getElementById("form-view"),
            "roadmap-view": document.getElementById("roadmap-view"),
            "etapa-view": document.getElementById("etapa-view"),
            "material-view": document.getElementById("material-view"),
            "flashcard-view": document.getElementById("flashcard-view"), // NOVO
            "simulado-etapa-view": document.getElementById("simulado-etapa-view"), // NOVO
            "chat-view": document.getElementById("chat-view")
        };
        
        function hideAllViews() {
            for (const key in viewMap) {
                viewMap[key].style.display = 'none';
            }
        }

        function showFormView() {
            hideAllViews();
            window.scrollTo(0, 0); 
            document.getElementById("chat-button").style.display = 'none'; 
            viewMap["form-view"].style.display = 'flex'; 
        }
        
        function showRoadmapView() {
            hideAllViews();
            window.scrollTo(0, 0); 
            if (modalState.etapas) document.getElementById("chat-button").style.display = 'block'; 
            patolindoState.lastView = "roadmap-view";
            viewMap["roadmap-view"].style.display = 'block';
        }

        function showEtapaView(etapa) {
            hideAllViews();
            window.scrollTo(0, 0); 
            document.getElementById("chat-button").style.display = 'block'; 
            patolindoState.lastView = "etapa-view";
            viewMap["etapa-view"].style.display = 'block';
            
            modalState.currentEtapa = etapa; 
            document.getElementById("etapa-titulo").innerText = etapa.titulo;
            
            const conteudo = etapa.topicos.map(t => {
                const topicoEscapado = t.tópico.replace(/'/g,"\\'"); 
                const materialLink = t.material ? t.material.replace(/'/g,"\\'") : "#"; 

                return `
                    <div class="topico-bloco">
                        <button class="material-btn" onclick="showMaterialView('${topicoEscapado}', '${materialLink}')">
                            📚 ${t.tópico}
                        </button>
                        <button class="btn-flashcard" onclick="showFlashcardView('${topicoEscapado}')">🧠 Gerar Flashcards</button>
                    </div>
                `;
            }).join("");

            // NOVO BOTÃO DE SIMULADO DA ETAPA
            const simularTudoBtn = `<button class="btn-primary btn-simulado-etapa" onclick="showSimuladoEtapaView()">🎯 Gerar Simulado Completo da Etapa (${etapa.topicos.length} Tópicos)</button>`;

            document.getElementById("etapa-conteudo").innerHTML = `
                <h3>📌 Atividade prática:</h3>
                <p>${etapa.atividade}</p>
                <h3>📚 Tópicos de Estudo:</h3>
                <div class="topicos-container">${conteudo}</div>
                ${simularTudoBtn}
            `;
        }

        function showChatView() {
            hideAllViews();
            window.scrollTo(0, 0); 
            document.getElementById("chat-button").style.display = 'none'; 
            viewMap["chat-view"].style.display = 'block';
            resetPatolindoSession();
        }

        function showLastView() {
            if (patolindoState.lastView === "roadmap-view") {
                showRoadmapView();
            } else if (patolindoState.lastView === "etapa-view") {
                showEtapaView(modalState.currentEtapa);
            } else {
                showRoadmapView(); 
            }
        }

        // --- FUNÇÕES DE CONTEÚDO ---

        async function gerarRoadmap() {
            const tema = document.getElementById("tema").value;
            const nivel = document.getElementById("nivel").value;
            const objetivo = document.getElementById("objetivo").value;
            const roadmapDiv = document.getElementById("roadmap");
            
            roadmapDiv.innerHTML = "✨ Gerando roadmap...";
            showRoadmapView(); 

            if (!tema) {
                roadmapDiv.innerHTML = "⚠️ Por favor, preencha o campo Tema.";
                return;
            }
            
            try {
                currentTheme = tema;

                const systemPrompt = `Você é um especialista em educação técnica. Crie um roadmap detalhado com **no mínimo 8 (oito) etapas obrigatórias**. Cada tópico deve ser ultra específico e **DEVE incluir uma URL de documentação oficial ou tutorial renomado** no campo 'material'. Sua única resposta deve ser APENAS JSON válido, sem texto introdutório ou blocos de código markdown. O JSON deve seguir este formato: {"etapas": [{"titulo": "Etapa 1: Nome da etapa", "topicos": [{"tópico": "Nome do tópico", "material": "URL de uma fonte externa"}], "atividade": "Descrição da atividade prática"}]}.`;
                const userPrompt = `Crie um roadmap de estudos detalhado e abrangente para o tema "${tema}" no nível "${nivel}"${objetivo ? ` com objetivo "${objetivo}"` : ""}. Inclua fontes externas de estudo no campo 'material' para todos os tópicos.`;

                const response = await fetch(GROQ_ENDPOINT, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${API_KEY}`
                    },
                    body: JSON.stringify({ 
                        model: MODEL_NAME,
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: userPrompt }
                        ],
                        response_format: { type: "json_object" }, 
                        temperature: 0.7 
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Erro API: ${response.status} - ${errorData.error.message || 'Erro desconhecido.'}`);
                }

                const data = await response.json();
                let texto = data?.choices?.[0]?.message?.content || "";

                let textoLimpo = texto.trim();
                let parsed;
                try {
                    parsed = JSON.parse(textoLimpo);
                } catch (e) {
                    let jsonMatch = textoLimpo.match(/\{[\s\S]*\}/);
                    if (!jsonMatch) throw new Error("Não foi possível extrair JSON da resposta.");
                    parsed = JSON.parse(jsonMatch[0]);
                }
                
                const etapas = parsed.etapas;
                modalState.etapas = etapas; 
                roadmapDiv.innerHTML = "";

                etapas.forEach(etapa => {
                    const blocoDiv = document.createElement("div");
                    blocoDiv.className = "bloco";
                    blocoDiv.innerText = etapa.titulo;
                    blocoDiv.onclick = () => showEtapaView(etapa);
                    roadmapDiv.appendChild(blocoDiv);
                });
                
                document.getElementById("chat-button").style.display = 'block'; 

            } catch (err) {
                console.error("Erro:", err);
                roadmapDiv.innerHTML = `⚠️ Erro ao gerar roadmap. Verifique sua chave API e tente novamente. Causa: ${err.message}.`;
                document.getElementById("chat-button").style.display = 'none'; 
            }
        }

        async function showMaterialView(topico, material) {
            hideAllViews();
            window.scrollTo(0, 0); 
            viewMap["material-view"].style.display = 'block';
            
            document.getElementById("material-titulo").innerText = topico;
            const materialConteudo = document.getElementById("material-conteudo");
            materialConteudo.innerHTML = `<p>Carregando conteúdo sobre: <strong>${topico}</strong>...</p>`;
            
            try {
                const userPromptMaterial = `Explique de forma didática e detalhada o tópico "${topico}".`;
                const response = await fetch(GROQ_ENDPOINT, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${API_KEY}` },
                    body: JSON.stringify({ model: MODEL_NAME, messages: [{ role: "user", content: userPromptMaterial }], temperature: 0.8 })
                });

                if (!response.ok) { throw new Error(`Erro API: ${response.status}`); }
                const data = await response.json();
                let texto = data?.choices?.[0]?.message?.content || "Erro ao gerar conteúdo.";

                texto = texto.replace(/\*\*(.*?)\*\*/g, "<b>$1</b>").replace(/\n/g, "<br>");

                let sourceHtml = '';
                if (material && material !== 'null' && material.startsWith('http')) {
                    sourceHtml = `<h3 style="margin-top: 30px; border-left: 5px solid var(--color-primary); padding-left: 12px;">🔗 Fonte Obrigatória</h3><p><a href="${material}" target="_blank" style="color: var(--color-primary-dark); font-weight: bold;">${material} (Abrirá em nova aba)</a></p>`;
                } else {
                    sourceHtml = '<p style="margin-top: 20px; color: #999;">Fonte externa não fornecida pela IA.</p>';
                }

                materialConteudo.innerHTML = `<div style="max-height:450px; overflow-y:auto; padding-right:10px;">${texto}</div>${sourceHtml}`;

            } catch (err) {
                console.error("Erro:", err);
                materialConteudo.innerHTML = `<p>⚠️ Erro ao gerar conteúdo. Causa: ${err.message}.</p>`;
            }
        }
        
        // --- FUNÇÃO NOVO: FLASHCARDS POR TÓPICO ---

        let currentFlashcards = [];
        let currentFlashcardIndex = 0;

        async function showFlashcardView(topico) {
            hideAllViews();
            window.scrollTo(0, 0); 
            viewMap["flashcard-view"].style.display = 'block';
            
            document.getElementById("flashcard-titulo").innerText = `Flashcards: ${topico}`;
            const flashcardDisplay = document.getElementById("flashcard-display");
            flashcardDisplay.innerHTML = `<p>Carregando flashcards sobre: <strong>${topico}</strong>...</p>`;

            try {
                const systemPromptFlashcard = `Você é um gerador de flashcards. Sua única resposta deve ser APENAS JSON válido, sem texto introdutório. O JSON deve ser um array de **5 objetos**, onde cada objeto tem uma "pergunta" (frente do card) e uma "resposta" (verso do card). O formato deve ser: [{"pergunta": "...", "resposta": "..."}, {"pergunta": "...", ...}].`;
                const userPromptFlashcard = `Crie 5 flashcards de pergunta e resposta sobre o tópico "${topico}" no nível ${document.getElementById("nivel").value}.`;

                const response = await fetch(GROQ_ENDPOINT, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${API_KEY}` },
                    body: JSON.stringify({ model: MODEL_NAME, messages: [{ role: "system", content: systemPromptFlashcard }, { role: "user", content: userPromptFlashcard }], response_format: { type: "json_object" }, temperature: 0.6 })
                });

                if (!response.ok) { throw new Error(`Erro API: ${response.status}`); }
                const data = await response.json();
                let texto = data?.choices?.[0]?.message?.content || "Erro ao gerar flashcards.";

                let parsedData;
                try {
                    parsedData = JSON.parse(texto.trim());
                } catch (e) {
                    let jsonMatch = texto.replace(/[\u0000-\u001F\u007F-\u009F]/g, "").trim().match(/\[[\s\S]*\]/);
                    if (!jsonMatch) throw new Error("Não foi possível extrair JSON dos flashcards.");
                    parsedData = JSON.parse(jsonMatch[0]);
                }
                
                currentFlashcards = Array.isArray(parsedData) ? parsedData : parsedData.flashcards || [parsedData];
                currentFlashcardIndex = 0;
                renderFlashcard();

            } catch (err) {
                console.error("Erro no Flashcard:", err);
                flashcardDisplay.innerHTML = `<p>⚠️ Erro ao gerar flashcards. Causa: ${err.message}.</p>`;
            }
        }
        
        function renderFlashcard() {
            const flashcardDisplay = document.getElementById("flashcard-display");
            
            if (currentFlashcards.length === 0) {
                flashcardDisplay.innerHTML = "<p>Nenhum flashcard gerado.</p>";
                return;
            }

            const card = currentFlashcards[currentFlashcardIndex];
            const total = currentFlashcards.length;

            flashcardDisplay.innerHTML = `
                <p>Card ${currentFlashcardIndex + 1} de ${total}</p>
                <div class="flashcard" id="current-flashcard" onclick="toggleFlip()">
                    <div class="flashcard-inner">
                        <div class="flashcard-face flashcard-front">
                            <p style="font-weight: bold;">PERGUNTA:</p>
                            <p>${card.pergunta}</p>
                        </div>
                        <div class="flashcard-face flashcard-back">
                            <p style="font-weight: bold;">RESPOSTA:</p>
                            <p>${card.resposta.replace(/\*\*(.*?)\*\*/g, "<b>$1</b>").replace(/\n/g, "<br>")}</p>
                        </div>
                    </div>
                </div>
                <div class="flashcard-navigation">
                    <button class="btn-secondary" onclick="prevFlashcard()" ${currentFlashcardIndex === 0 ? 'disabled' : ''}>Anterior</button>
                    <button class="btn-success" onclick="nextFlashcard()" ${currentFlashcardIndex === total - 1 ? 'disabled' : ''}>Próximo</button>
                </div>
            `;
        }

        function toggleFlip() {
            document.getElementById('current-flashcard').classList.toggle('flipped');
        }

        function prevFlashcard() {
            if (currentFlashcardIndex > 0) {
                currentFlashcardIndex--;
                renderFlashcard();
            }
        }

        function nextFlashcard() {
            if (currentFlashcardIndex < currentFlashcards.length - 1) {
                currentFlashcardIndex++;
                renderFlashcard();
            }
        }

        // --- FUNÇÃO NOVO: SIMULADO POR ETAPA ---

        let currentSimuladoEtapa = [];
        let userAnswers = {};

        async function showSimuladoEtapaView() {
            hideAllViews();
            window.scrollTo(0, 0); 
            viewMap["simulado-etapa-view"].style.display = 'block';

            const etapa = modalState.currentEtapa;
            document.getElementById("simulado-etapa-titulo").innerText = `Simulado Completo: ${etapa.titulo}`;
            const simuladoConteudo = document.getElementById("simulado-etapa-conteudo");
            const simuladoBotoes = document.getElementById("simulado-etapa-botoes");

            simuladoConteudo.innerHTML = `<p>Carregando simulado de 20+ questões sobre a etapa: <strong>${etapa.titulo}</strong>...</p>`;
            simuladoBotoes.innerHTML = '';
            currentSimuladoEtapa = [];
            userAnswers = {};

            try {
                const systemPromptSimulado = `Você é um gerador de questões de múltipla escolha. Crie um simulado de no mínimo 20 (vinte) questões sobre todos os tópicos fornecidos. Sua única resposta deve ser APENAS JSON válido, sem texto introdutório. O JSON deve ser um objeto contendo um array de "simulados" seguindo o formato: {"simulados": [{"pergunta": "...", "alternativas": ["A) ...", "B) ...", "C) ...", "D) ...", "E) ..."], "resposta_correta": "Letra da alternativa correta (ex: C)"}, ...]}.`;
                const topicosEtapa = etapa.topicos.map(t => t.tópico).join(", ");
                const userPromptSimulado = `Crie no mínimo 20 questões de múltipla escolha sobre os seguintes tópicos da etapa: ${topicosEtapa} no nível ${document.getElementById("nivel").value}. Cada questão deve ter 5 alternativas.`;

                const response = await fetch(GROQ_ENDPOINT, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${API_KEY}` },
                    body: JSON.stringify({ model: MODEL_NAME, messages: [{ role: "system", content: systemPromptSimulado }, { role: "user", content: userPromptSimulado }], response_format: { type: "json_object" }, temperature: 0.6 })
                });

                if (!response.ok) { throw new Error(`Erro API: ${response.status}`); }
                const data = await response.json();
                let texto = data?.choices?.[0]?.message?.content || "Erro ao gerar simulado.";

                let parsedData;
                try {
                    parsedData = JSON.parse(texto.trim());
                } catch (e) {
                    let jsonMatch = texto.replace(/[\u0000-\u001F\u007F-\u009F]/g, "").trim().match(/\{[\s\S]*\}/);
                    if (!jsonMatch) throw new Error("Não foi possível extrair JSON do simulado.");
                    parsedData = JSON.parse(jsonMatch[0]);
                }
                
                currentSimuladoEtapa = parsedData.simulados || [parsedData];
                renderSimuladoEtapa();

            } catch (err) {
                console.error("Erro no Simulado Etapa:", err);
                simuladoConteudo.innerHTML = `<p>⚠️ Erro ao gerar simulado da etapa. Causa: ${err.message}.</p>`;
            }
        }

        function renderSimuladoEtapa() {
            const simuladoConteudo = document.getElementById("simulado-etapa-conteudo");
            const simuladoBotoes = document.getElementById("simulado-etapa-botoes");

            if (currentSimuladoEtapa.length === 0) {
                 simuladoConteudo.innerHTML = "<p>Nenhuma questão gerada.</p>";
                 return;
            }

            const simuladosHtml = currentSimuladoEtapa.map((simulado, index) => {
                const alternativasHtml = simulado.alternativas.map((alt, altIndex) => {
                    const letra = alt.charAt(0);
                    const isSelected = userAnswers[index] === letra;
                    return `<li class="alternativa ${isSelected ? 'selected' : ''}" 
                                data-question-index="${index}" 
                                data-answer="${letra}" 
                                onclick="selectAlternative(this)">
                                ${alt}
                            </li>`;
                }).join("");

                return `<div class="simulado-bloco" data-index="${index}">
                            <h4>Questão ${index + 1}:</h4>
                            <p><strong>${simulado.pergunta}</strong></p>
                            <ul>${alternativasHtml}</ul>
                        </div><hr>`;
            }).join("");

            simuladoConteudo.innerHTML = `<div class="simulado-area">${simuladosHtml}</div><div id="simulado-resultado" style="display:none;"></div>`;
            
            // Botão de corrigir só aparece se o simulado existir
            simuladoBotoes.innerHTML = `<button class="btn-primary" onclick="corrigirSimuladoEtapa()">Corrigir e Ver Resultado</button>`;
        }
        
        function selectAlternative(liElement) {
            const questionIndex = liElement.getAttribute('data-question-index');
            const answer = liElement.getAttribute('data-answer');
            const ul = liElement.closest('ul');
            
            // Remove seleção de todas as alternativas
            ul.querySelectorAll('.alternativa').forEach(li => li.classList.remove('selected'));
            
            // Adiciona seleção à alternativa clicada
            liElement.classList.add('selected');
            
            // Armazena a resposta do usuário
            userAnswers[questionIndex] = answer;
        }

        function corrigirSimuladoEtapa() {
            let acertos = 0;
            const totalQuestoes = currentSimuladoEtapa.length;

            currentSimuladoEtapa.forEach((simulado, index) => {
                const bloco = document.querySelector(`.simulado-bloco[data-index="${index}"]`);
                if (!bloco) return;
                
                const alternativas = bloco.querySelectorAll('.alternativa');
                const respostaCorreta = simulado.resposta_correta.charAt(0);
                const respostaUsuario = userAnswers[index];
                
                // Desabilita cliques após a correção
                alternativas.forEach(li => li.onclick = null);

                alternativas.forEach(li => {
                    const letra = li.getAttribute('data-answer');
                    li.classList.remove('selected'); // Remove a seleção temporária

                    if (letra === respostaCorreta) {
                        li.classList.add('correta-destacada'); // Marca a correta
                    } 
                    
                    if (letra === respostaUsuario && letra !== respostaCorreta) {
                        li.classList.add('incorreta'); // Marca a incorreta do usuário
                    }
                });

                if (respostaUsuario === respostaCorreta) {
                    acertos++;
                }
            });

            const porcentagem = (acertos / totalQuestoes) * 100;
            const resultadoDiv = document.getElementById('simulado-resultado');
            
            resultadoDiv.innerHTML = `
                <h3>Resultado Final</h3>
                <p>Total de Questões: <strong>${totalQuestoes}</strong></p>
                <p>Acertos: <strong style="color: var(--color-success);">${acertos}</strong></p>
                <p>Erros: <strong style="color: var(--color-danger);">${totalQuestoes - acertos}</strong></p>
                <p>Taxa de Acerto: <strong style="font-size: 1.5em; color: ${porcentagem >= 70 ? 'var(--color-success)' : 'var(--color-danger)'}">${porcentagem.toFixed(2)}%</strong></p>
            `;
            resultadoDiv.style.display = 'block';
            
            // Remove o botão de corrigir
            document.getElementById("simulado-etapa-botoes").innerHTML = '';
            
            // Rola para o resultado
            resultadoDiv.scrollIntoView({ behavior: 'smooth' });
        }


        // --- LÓGICA DO CHATBOT PATOLINDO (COM RESTRIÇÃO DE TEMA) ---

        function updateSendButtonState() {
            const input = document.getElementById("chat-input");
            const sendButton = document.getElementById("chat-send-button");
            const headerSpan = document.getElementById("chat-counter");
            
            sendButton.disabled = input.value.trim() === '' || patolindoState.questionsLeft <= 0;
            input.disabled = patolindoState.questionsLeft <= 0;
            
            headerSpan.innerText = `(${patolindoState.questionsLeft} Perguntas)`;

            if (patolindoState.questionsLeft <= 0) {
                input.placeholder = "Sessão encerrada. Reabra para começar de novo.";
            } else {
                input.placeholder = "Sua pergunta...";
            }
        }

        function resetPatolindoSession() {
            patolindoState.questionsLeft = 5;
            
            const themeRestriction = currentTheme ? `O ÚNICO TEMA permitida para conversação é: "${currentTheme}". Você deve RECUSAR educadamente perguntas fora deste assunto.` : "Nenhuma trilha de estudos foi gerada. Você deve recusar perguntas até que uma trilha seja gerada.";

            patolindoState.history = [{
                role: "system",
                content: `Você é o Patolindo, um assistente de estudos prestativo e didático. Sua função é responder a no máximo 5 perguntas do usuário. Seja conciso e focado. ${themeRestriction}`
            }]; 

            const chatMessages = document.getElementById("chat-messages");
            chatMessages.innerHTML = `<p class="bot-message"><span class="bot-bubble">Olá! Sou o Patolindo. Você tem **${patolindoState.questionsLeft} perguntas** para tirar dúvidas sobre a sua trilha atual (${currentTheme || 'NENHUM TEMA'}).</span></p>`;
            chatMessages.scrollTop = chatMessages.scrollHeight; 
            updateSendButtonState();
        }

        async function handleChatSend() {
            const input = document.getElementById("chat-input");
            const question = input.value.trim();
            
            if (!question || patolindoState.questionsLeft <= 0) return;
            
            appendMessage(question, 'user');
            input.value = ''; 
            
            const sendButton = document.getElementById("chat-send-button");
            sendButton.disabled = true; 
            
            try {
                patolindoState.history.push({ role: "user", content: question });

                const roadmapContext = modalState.etapas ? JSON.stringify(modalState.etapas) : "Nenhuma trilha de estudos foi gerada ainda.";
                
                const systemContext = {
                    role: "system",
                    content: patolindoState.history[0].content + 
                             ` O contexto da trilha de estudos atual do usuário é: ${roadmapContext}. Você deve ser rigoroso em se manter APENAS no tema da trilha.`
                };
                
                const messagesToSend = [systemContext].concat(patolindoState.history.slice(1)); 

                const response = await fetch(GROQ_ENDPOINT, {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${API_KEY}` },
                    body: JSON.stringify({ model: MODEL_NAME, messages: messagesToSend, temperature: 0.8 })
                });

                if (!response.ok) { throw new Error(`Erro API: ${response.status}`); }

                const data = await response.json();
                const answer = data?.choices?.[0]?.message?.content || "Desculpe, não consegui processar a sua pergunta no momento.";

                appendMessage(answer, 'bot');
                
                const isRefusal = answer.toLowerCase().includes("não consigo responder") || answer.toLowerCase().includes("fora do tema");

                if (!isRefusal) {
                    patolindoState.history.push({ role: "assistant", content: answer });
                    patolindoState.questionsLeft--;
                } else {
                     patolindoState.history.push({ role: "assistant", content: answer });
                }
                
            } catch (err) {
                console.error("Erro no Patolindo:", err);
                appendMessage("Patolindo: Desculpe, ocorreu um erro de comunicação. Tente novamente.", 'bot');
            } finally {
                sendButton.disabled = false;
                updateSendButtonState();
            }
        }
        
        function appendMessage(text, sender) {
            const chatMessages = document.getElementById("chat-messages");
            const messageElement = document.createElement("p");
            
            if (sender === 'user') {
                messageElement.className = 'user-message';
                messageElement.innerHTML = `<span class="user-bubble">${text}</span>`;
            } else {
                messageElement.className = 'bot-message';
                const htmlText = text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, "<br>");
                messageElement.innerHTML = `<span class="bot-bubble">${htmlText}</span>`;
            }
            
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

    </script>
</body>
</html>
