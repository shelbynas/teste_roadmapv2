<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quackademy</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');

        :root {
            --color-primary: #FFD700; /* Dourado/Amarelo Pato */
            --color-secondary: #333333;
            --color-background: #F4F7F9;
            --color-card: #FFFFFF;
            --color-text: #333333;
            --color-light-text: #6c757d;
            --color-success: #28a745;
            --color-danger: #dc3545;
            --color-shadow: rgba(0, 0, 0, 0.1);
            --color-chat-bg: #e9ecef;
            --color-patolindo: #007bff;
            --color-patolindo-light: #f0f8ff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: var(--color-background);
            color: var(--color-text);
            min-height: 100vh;
        }

        #app-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        header {
            background-color: var(--color-card);
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: var(--color-shadow) 0px 4px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            color: var(--color-secondary);
            font-size: 1.5rem;
            display: flex;
            align-items: center;
        }
        
        header .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        header .user-info span {
            font-weight: 600;
        }
        
        /* Bot√µes */
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: var(--color-secondary);
        }

        .btn-primary:hover {
            background-color: #ffc700;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background-color: var(--color-secondary);
            color: var(--color-card);
        }

        .btn-secondary:hover {
            background-color: #555555;
            transform: translateY(-1px);
        }

        .btn-danger {
            background-color: var(--color-danger);
            color: var(--color-card);
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--color-secondary);
            color: var(--color-secondary);
        }

        .btn-outline:hover {
            background-color: var(--color-secondary);
            color: var(--color-card);
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* Cards */
        .card {
            background-color: var(--color-card);
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--color-shadow) 0px 4px 12px;
        }

        /* Vistas */
        .view {
            display: none;
        }
        
        /* Formul√°rios */
        form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        input[type="text"], 
        input[type="password"], 
        textarea, 
        select {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            width: 100%;
        }

        /* Roadmap */
        .roadmap-header {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .roadmap-header h2 {
            color: var(--color-patolindo);
            margin-bottom: 5px;
        }

        .roadmap-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .etapa-item {
            display: flex;
            align-items: center;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-left: 5px solid var(--color-patolindo);
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .etapa-item:hover {
            background-color: #e9ecef;
        }

        .etapa-status {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            margin-right: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--color-card);
            font-size: 0.8rem;
            font-weight: 700;
        }

        .status-pendente { background-color: #ffc107; }
        .status-em-progresso { background-color: var(--color-patolindo); }
        .status-concluido { background-color: var(--color-success); }

        .etapa-info h3 {
            font-size: 1.1rem;
            margin-bottom: 3px;
        }
        
        .etapa-info p {
            font-size: 0.9rem;
            color: var(--color-light-text);
        }

        /* Etapa View */
        #etapa-view h2 {
            color: var(--color-patolindo);
            margin-bottom: 10px;
        }

        #material-content {
            margin-top: 15px;
            padding: 15px;
            border: 1px dashed #ccc;
            border-radius: 8px;
            white-space: pre-wrap;
            background-color: var(--color-patolindo-light);
        }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none; /* Escondido por padr√£o */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: var(--color-card);
            padding: 30px;
            border-radius: 15px;
            max-width: 90%;
            width: 500px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            text-align: center;
        }
        
        /* Estilos de Login/Welcome */
        #login-view, #welcome-view, #explanation-view {
            text-align: center;
            padding-top: 100px;
        }
        
        #login-form {
            max-width: 350px;
            margin: 20px auto;
            background: var(--color-card);
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--color-shadow) 0px 4px 12px;
        }

        /* Lista de Trilhas */
        .trilha-card {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        .trilha-card-info {
            cursor: pointer;
            flex-grow: 1;
            text-align: left;
        }
        
        .trilha-card-info h4 {
            color: var(--color-patolindo);
            margin-bottom: 5px;
        }
        
        .trilha-actions {
            display: flex;
            gap: 10px;
        }
        
        /* Patolindo Chat */
        #chat-view {
            display: flex;
            flex-direction: column;
            height: 70vh;
        }

        #chat-history {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            background-color: var(--color-chat-bg);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 10px;
            max-width: 80%;
        }

        .message-user {
            background-color: var(--color-primary);
            margin-left: auto;
            text-align: right;
        }

        .message-patolindo {
            background-color: var(--color-card);
            margin-right: auto;
            border: 1px solid #ddd;
        }

        #chat-input-container {
            display: flex;
            gap: 10px;
        }
        
        #chat-input {
            flex-grow: 1;
        }
        
        .disabled-chat {
            opacity: 0.5;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="app-container">
        
        <div id="login-view" class="view">
            <div class="card" style="max-width: 400px; margin: 0 auto;">
                <img src="pato_logo.png" alt="Quackademy Logo" style="width: 100px; margin-bottom: 20px;">
                <h2>Acesso √† Quackademy</h2>
                <p style="color: var(--color-light-text); margin-bottom: 20px;">Entre com sua conta ou crie uma nova para salvar suas trilhas!</p>
                
                <form id="login-form">
                    <input type="text" id="username" placeholder="Nome de Usu√°rio" required minlength="3">
                    <input type="password" id="password" placeholder="Senha" required minlength="3">
                    <button type="submit" class="btn-primary">Entrar / Cadastrar</button>
                    <p id="auth-message" style="color: var(--color-danger);"></p>
                </form>
                
                <button type="button" id="btnSkipLogin" class="btn-outline" style="margin-top: 15px;">
                    Continuar como Convidado
                </button>
            </div>
        </div>

        <div id="welcome-view" class="view card">
            <h2>Bem-vindo(a), <span id="welcomeUserNameDisplay">Usu√°rio!</span></h2>
            <p style="margin-top: 15px;">Voc√™ acaba de acessar a Quackademy, o seu gerador de trilhas de conhecimento personalizado. Vamos te guiar na cria√ß√£o da sua primeira jornada de aprendizado!</p>
            <div class="btn-group">
                <button id="btnWelcomeContinue" class="btn-primary">Continuar</button>
            </div>
        </div>

        <div id="explanation-view" class="view card">
            <h2>Como Funciona?</h2>
            <p style="margin-top: 15px;">1. **Tema:** Voc√™ diz o que quer aprender (Ex: "ReactJS", "Cozinha Italiana").</p>
            <p>2. **N√≠vel:** Escolhe o seu n√≠vel (Iniciante, Intermedi√°rio, Avan√ßado).</p>
            <p>3. **Objetivo:** Define o que quer alcan√ßar (Ex: "Fazer um site completo").</p>
            <p style="margin-bottom: 20px;">O Patolindo Bot (nosso assistente IA) gera uma trilha de aprendizado com etapas detalhadas, materiais de estudo e dicas.</p>
            <div class="btn-group">
                <button id="btnExplanationContinue" class="btn-secondary">Come√ßar</button>
            </div>
        </div>

        <div id="main-app-view" class="view">
            <header>
                <h1>ü¶Ü Quackademy</h1>
                <div class="user-info">
                    <span>Ol√°, <span id="userNameDisplay"></span></span>
                    <span id="trilhasCountDisplay">0 Trilhas</span>
                    <button id="btnShowTrilhas" class="btn-outline">Minhas Trilhas</button>
                    <button id="btnLogout" class="btn-danger">Sair</button>
                </div>
            </header>

            <div id="generator-view" class="card">
                <h2>Crie sua Jornada</h2>
                <form id="roadmap-form">
                    <label for="inputTema">Qual tema voc√™ quer dominar?</label>
                    <input type="text" id="inputTema" placeholder="Ex: Programa√ß√£o Python, Design UI/UX" required>

                    <label for="inputNivel">Seu n√≠vel atual:</label>
                    <select id="inputNivel" required>
                        <option value="">Selecione...</option>
                        <option value="Iniciante">Iniciante</option>
                        <option value="Intermedi√°rio">Intermedi√°rio</option>
                        <option value="Avan√ßado">Avan√ßado</option>
                    </select>

                    <label for="inputObjetivo">Qual o seu objetivo principal?</label>
                    <textarea id="inputObjetivo" placeholder="Ex: Criar um aplicativo de receitas completo com banco de dados." rows="2" required></textarea>

                    <label for="inputReferencia">Materiais de Refer√™ncia (Opcional)</label>
                    <textarea id="inputReferencia" placeholder="Cole links, URLs de documenta√ß√£o ou resumos de PDFs aqui para a IA usar como base." rows="3"></textarea>
                    
                    <button type="button" id="btnGerar" class="btn-primary">Gerar Minha Trilha</button>
                </form>
                
                <h3 style="margin-top: 30px; text-align: center;">Ou comece com um de nossos Roadmaps Pr√©-definidos:</h3>
                <div id="predefined-courses-list" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; justify-content: center;">
                    </div>
            </div>

            <div id="user-trilhas-view" class="card view">
                <h2>Minhas Trilhas Salvas</h2>
                <div id="trilhas-list">
                    </div>
                <button id="btnBackToGenerator" class="btn-secondary">Nova Trilha</button>
            </div>

            <div id="roadmap-view" class="card view">
                <div class="roadmap-header">
                    <h2 id="roadmap-title"></h2>
                    <p id="roadmap-details"></p>
                </div>
                
                <div id="roadmap-etapas-list" class="roadmap-list">
                    </div>
                
                <div class="btn-group">
                    <button id="btnBackToMain" class="btn-secondary">Voltar (Gerar)</button>
                    <button id="btnShowChatbot" class="btn-primary">Fale com Patolindo</button>
                </div>
            </div>

            <div id="etapa-view" class="card view">
                <h2 id="etapa-title"></h2>
                <p id="etapa-status-detail"></p>
                
                <div class="btn-group">
                    <button id="btnMarkComplete" class="btn-success">Marcar como Conclu√≠do</button>
                    <button id="btnBackToRoadmap" class="btn-outline">Voltar √† Trilha</button>
                </div>

                <h3 style="margin-top: 20px;">Material de Estudo:</h3>
                <div id="material-content">
                    <p>Carregando material...</p>
                </div>
            </div>
            
            <div id="chat-view" class="card view">
                <h2>Patolindo Bot üí¨</h2>
                <p id="chat-status" style="margin-bottom: 10px; font-weight: 600;">Consultas restantes: <span id="questionsLeftDisplay">5</span></p>

                <div id="chat-history">
                    <div class="chat-message message-patolindo">
                        Ol√°! Sou o Patolindo. Posso tirar d√∫vidas sobre a etapa atual da sua trilha.
                    </div>
                </div>

                <div id="chat-input-container">
                    <input type="text" id="chat-input" placeholder="Pergunte sobre a etapa..." maxlength="200">
                    <button id="btnChatSend" class="btn-primary">Enviar</button>
                </div>
                
                <button id="btnBackToRoadmapFromChat" class="btn-secondary" style="margin-top: 10px;">Voltar √† Trilha</button>
            </div>

        </div>

        <div id="loadingModal" class="modal">
            <div class="modal-content">
                <img src="pato_animado.gif" alt="Pato Gerando" style="width: 80px; margin-bottom: 15px;">
                <h3>Processando sua trilha...</h3>
                <p>O Patolindo Bot est√° buscando os melhores conte√∫dos. Aguarde um momento.</p>
            </div>
        </div>

    </div>

    <script>
        // ===================================================================
        // JAVASCRIPT COMPLETO E FUNCIONAL (Utilizando LocalStorage)
        // ===================================================================

        // --- CHAVES DE CONFIGURA√á√ÉO ---
        
        // Chave da API Groq (Mantida a partir do seu c√≥digo anterior)
        const API_KEY = "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"; 
        
        const GROQ_ENDPOINT = "https://api.groq.com/openai/v1/chat/completions";
        const MODEL_NAME = "llama-3.1-8b-instant"; 
        
        // Chave para o Local Storage (Agora usa o username como chave principal)
        const LOCAL_STORAGE_PREFIX = "quackademyUser_"; 


        // --- SISTEMA DE ESTADO GLOBAL ---
        let currentUser = {
            name: null, 
            trilhas: [], 
            currentTrilhaIndex: -1 
        };
        
        let patolindoState = {
            questionsLeft: 5,
            history: [],
            lastView: "roadmap-view" 
        };
        
        // --- DADOS PR√â-DEFINIDOS ---
        const preDefinedRoadmaps = [
            {
                tema: "JavaScript B√°sico",
                nivel: "Iniciante",
                objetivo: "Dominar vari√°veis, loops e fun√ß√µes para criar scripts interativos.",
                etapas: [
                    { nome: "Fundamentos de Vari√°veis e Tipos", status: "pendente", material: "" },
                    { nome: "Estruturas de Controle (If/Else)", status: "pendente", material: "" },
                    { nome: "Loops (For e While)", status: "pendente", material: "" },
                    { nome: "Fun√ß√µes e Escopo", status: "pendente", material: "" },
                    { nome: "Manipula√ß√£o B√°sica do DOM", status: "pendente", material: "" }
                ]
            },
            {
                tema: "Design UI/UX",
                nivel: "Iniciante",
                objetivo: "Compreender princ√≠pios de usabilidade e criar wireframes simples.",
                etapas: [
                    { nome: "O que √© UX e UI?", status: "pendente", material: "" },
                    { nome: "Princ√≠pios de Usabilidade", status: "pendente", material: "" },
                    { nome: "Cria√ß√£o de Personas", status: "pendente", material: "" },
                    { nome: "Wireframing e Prototipagem", status: "pendente", material: "" }
                ]
            }
        ];
        
        // --- FUN√á√ïES DE PERSIST√äNCIA (LOCAL STORAGE) ---

        /**
         * Gera a chave √∫nica do LocalStorage para o usu√°rio.
         */
        function getLocalStorageKey(username) {
            return LOCAL_STORAGE_PREFIX + username.toLowerCase().replace(/[^a-z0-9]/g, '');
        }

        /**
         * Carrega os dados do usu√°rio do LocalStorage.
         */
        function loadUserData(username) {
            currentUser.name = username;
            document.getElementById("welcomeUserNameDisplay").innerText = username;

            const key = getLocalStorageKey(username);
            
            // Tenta carregar dados existentes, sen√£o inicia com trilhas vazias
            const savedData = JSON.parse(localStorage.getItem(key) || '{"trilhas":[], "currentTrilhaIndex":-1}');
            currentUser.trilhas = savedData.trilhas;
            currentUser.currentTrilhaIndex = savedData.currentTrilhaIndex;

            document.getElementById("userNameDisplay").innerText = currentUser.name;
            updateTrilhasCountDisplay();
        }

        /**
         * Salva o estado atual das trilhas do usu√°rio atual no LocalStorage.
         */
        function saveUserTrilhas() {
            if (currentUser.name && currentUser.name !== 'Convidado') {
                const key = getLocalStorageKey(currentUser.name);
                const dataToSave = {
                    trilhas: currentUser.trilhas,
                    currentTrilhaIndex: currentUser.currentTrilhaIndex
                };
                localStorage.setItem(key, JSON.stringify(dataToSave));
            }
            updateTrilhasCountDisplay();
        }
        
        /**
         * Salva a trilha espec√≠fica e chama saveUserTrilhas.
         */
        function saveTrilhaToPersistence(trilhaObject, index) {
            if (currentUser.name === 'Convidado') return;
            
            if (index !== undefined && index !== -1) {
                currentUser.trilhas[index] = trilhaObject;
            }
            saveUserTrilhas();
        }

        // --- FUN√á√ïES DE AUTENTICA√á√ÉO E NAVEGA√á√ÉO ---
        
        function showView(viewId) {
            document.querySelectorAll('.view').forEach(view => {
                view.style.display = 'none';
            });
            document.getElementById(viewId).style.display = 'block';
        }

        function showLoginView() { 
            showView('login-view'); 
            document.getElementById('auth-message').innerText = '';
        }

        function showWelcomeScreen() {
            document.getElementById("welcomeUserNameDisplay").innerText = currentUser.name;
            showView('welcome-view');
        }

        function showExplanationScreen() {
            showView('explanation-view');
        }

        function showGeneratorView() {
            showView('generator-view');
        }

        function showMainApp(isReload) {
            showView('main-app-view');
            
            // Se o app for recarregado e tiver uma trilha ativa, vai direto para ela
            if (isReload && currentUser.currentTrilhaIndex !== -1) {
                const trilha = currentUser.trilhas[currentUser.currentTrilhaIndex];
                loadRoadmap(trilha);
            } else {
                showGeneratorView();
            }
            renderPreDefinedCourses();
        }

        function handleAuthSubmit(e) {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const authMessage = document.getElementById('auth-message');
            authMessage.innerText = 'Processando...';
            
            if (username.length < 3 || password.length < 3) {
                authMessage.innerText = "Nome de usu√°rio e senha devem ter no m√≠nimo 3 caracteres.";
                return;
            }
            
            // Simula login/cadastro baseado no username
            loadUserData(username);
            
            authMessage.innerText = `Login bem-sucedido para ${username}!`;
            showMainApp(true);
        }
        
        function handleSkipLogin() {
            currentUser.name = 'Convidado';
            currentUser.trilhas = [];
            currentUser.currentTrilhaIndex = -1;
            document.getElementById("userNameDisplay").innerText = currentUser.name;
            updateTrilhasCountDisplay();
            showWelcomeScreen();
        }

        function handleLogout() {
            // Limpa o estado da sess√£o atual
            currentUser = { name: null, trilhas: [], currentTrilhaIndex: -1 };
            // N√£o limpa o localStorage, mantendo os dados salvos para o pr√≥ximo login
            showLoginView();
        }

        // --- FUN√á√ïES DE ROADMAP E ETAPAS ---

        function updateTrilhasCountDisplay() {
            const count = currentUser.trilhas.length;
            document.getElementById("trilhasCountDisplay").innerText = `${count} Trilha${count !== 1 ? 's' : ''}`;
        }
        
        function getStatusClass(status) {
            switch (status) {
                case 'concluido': return 'status-concluido';
                case 'em-progresso': return 'status-em-progresso';
                default: return 'status-pendente';
            }
        }

        function loadRoadmap(trilha) {
            document.getElementById("roadmap-title").innerText = trilha.tema;
            document.getElementById("roadmap-details").innerText = `N√≠vel: ${trilha.nivel} | Objetivo: ${trilha.objetivo}`;
            
            const list = document.getElementById("roadmap-etapas-list");
            list.innerHTML = '';

            trilha.etapas.forEach((etapa, index) => {
                const item = document.createElement('li');
                item.className = 'etapa-item';
                item.dataset.index = index;
                item.onclick = () => showEtapaView(index);

                item.innerHTML = `
                    <div class="etapa-status ${getStatusClass(etapa.status)}">
                        ${index + 1}
                    </div>
                    <div class="etapa-info">
                        <h3>${etapa.nome}</h3>
                        <p>Status: ${etapa.status.toUpperCase().replace('-', ' ')}</p>
                    </div>
                `;
                list.appendChild(item);
            });

            showView('roadmap-view');
        }

        function showEtapaView(index) {
            const trilha = currentUser.trilhas[currentUser.currentTrilhaIndex];
            const etapa = trilha.etapas[index];

            document.getElementById("etapa-title").innerText = etapa.nome;
            document.getElementById("etapa-status-detail").innerText = `Status: ${etapa.status.toUpperCase().replace('-', ' ')}`;
            document.getElementById("btnMarkComplete").dataset.index = index;
            
            // Mostra ou esconde o bot√£o de conclus√£o
            const btnComplete = document.getElementById("btnMarkComplete");
            if (etapa.status === 'concluido') {
                btnComplete.style.display = 'none';
            } else {
                btnComplete.style.display = 'block';
                // Muda para 'em-progresso' se for a primeira vez que entra
                if (etapa.status === 'pendente') {
                    etapa.status = 'em-progresso';
                    saveTrilhaToPersistence(trilha, currentUser.currentTrilhaIndex); 
                }
            }

            fetchAndRenderMaterial(trilha, index);
            showView('etapa-view');
        }

        function markEtapaComplete(e) {
            const index = parseInt(e.target.dataset.index);
            const trilha = currentUser.trilhas[currentUser.currentTrilhaIndex];
            const etapa = trilha.etapas[index];

            etapa.status = 'concluido';
            e.target.style.display = 'none';
            document.getElementById("etapa-status-detail").innerText = 'Status: CONCLU√çDO';
            
            // Salva o status atualizado no LocalStorage
            saveTrilhaToPersistence(trilha, currentUser.currentTrilhaIndex); 
            
            // Verifica se a trilha toda foi conclu√≠da
            if (trilha.etapas.every(e => e.status === 'concluido')) {
                alert(`Parab√©ns! Voc√™ concluiu a trilha "${trilha.tema}"!`);
            }
        }
        
        // --- FUN√á√ïES DE RENDERIZA√á√ÉO E DELE√á√ÉO DE TRILHAS ---
        
        function renderPreDefinedCourses() {
            const list = document.getElementById("predefined-courses-list");
            list.innerHTML = '';

            preDefinedRoadmaps.forEach(trilha => {
                const btn = document.createElement('button');
                btn.className = 'btn-outline';
                btn.innerText = `${trilha.tema} (${trilha.nivel})`;
                
                // Salva o JSON completo na string para carregar
                btn.onclick = () => loadPreDefinedRoadmap(JSON.stringify(trilha)); 
                list.appendChild(btn);
            });
        }
        
        function showUserTrilhasView() {
            const list = document.getElementById("trilhas-list");
            list.innerHTML = '';

            if (currentUser.trilhas.length === 0) {
                list.innerHTML = '<p style="text-align: center;">Voc√™ ainda n√£o tem trilhas salvas.</p>';
            } else {
                currentUser.trilhas.forEach((trilha, index) => {
                    const card = document.createElement('div');
                    card.className = 'trilha-card';
                    
                    const concluidoCount = trilha.etapas.filter(e => e.status === 'concluido').length;
                    const totalCount = trilha.etapas.length;
                    
                    card.innerHTML = `
                        <div class="trilha-card-info" onclick="loadTrilhaByIdx(${index})">
                            <h4>${trilha.tema} (${trilha.nivel})</h4>
                            <p>Progresso: ${concluidoCount} / ${totalCount} etapas</p>
                        </div>
                        <div class="trilha-actions">
                            <button class="btn-danger" onclick="deleteTrilha(${index})">Excluir</button>
                        </div>
                    `;
                    list.appendChild(card);
                });
            }
            showView('user-trilhas-view');
        }
        
        function loadTrilhaByIdx(index) {
             currentUser.currentTrilhaIndex = index;
             const trilha = currentUser.trilhas[index];
             loadRoadmap(trilha);
             saveUserTrilhas(); // Atualiza o localStorage com o novo √≠ndice ativo
        }

        function deleteTrilha(index) {
             if (currentUser.name === 'Convidado') return;

             const trilhaToDelete = currentUser.trilhas[index];

            if (confirm(`Tem certeza que deseja excluir a trilha "${trilhaToDelete.tema}"?`)) {
                
                // 1. Remove da mem√≥ria
                currentUser.trilhas.splice(index, 1);
                
                // 2. Ajusta o √≠ndice ativo
                if (currentUser.currentTrilhaIndex === index) {
                    currentUser.currentTrilhaIndex = -1;
                } else if (currentUser.currentTrilhaIndex > index) {
                    currentUser.currentTrilhaIndex--;
                }
                
                saveUserTrilhas();
                showUserTrilhasView(); 
            }
        }

        // --- FUN√á√ïES DE GERA√á√ÉO E API ---

        async function fetchMaterialFromGroq(tema, etapaNome, historicoChat) {
             const systemPrompt = `Voc√™ √© um assistente educacional que gera material de estudo detalhado sobre o t√≥pico solicitado. O material deve ser formatado em Markdown, com subt√≠tulos, t√≥picos e links para recursos externos (URLs fict√≠cias, mas realistas) no final. O material deve ser informativo e pr√°tico. T√≥pico principal: ${tema}. Etapa atual: ${etapaNome}.`;

            const messages = [
                { role: "system", content: systemPrompt },
                ...historicoChat
            ];

            try {
                const response = await fetch(GROQ_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: MODEL_NAME,
                        messages: messages,
                        temperature: 0.7,
                        max_tokens: 1500,
                    }),
                });

                if (!response.ok) {
                    throw new Error(`Erro na API Groq: ${response.statusText}`);
                }

                const data = await response.json();
                return data.choices[0].message.content;
            } catch (error) {
                console.error("Erro ao comunicar com a API Groq:", error);
                return "Desculpe, houve um erro ao buscar o material. Tente novamente mais tarde.";
            }
        }
        
        async function fetchAndRenderMaterial(trilha, index) {
            const etapa = trilha.etapas[index];
            const contentDiv = document.getElementById("material-content");
            contentDiv.innerHTML = '<p>Carregando material...</p>';

            // Se o material j√° foi gerado, usa a vers√£o salva
            if (etapa.material && etapa.material.length > 10) {
                contentDiv.innerText = etapa.material;
                return;
            }

            // Se for novo, gera o material
            const material = await fetchMaterialFromGroq(trilha.tema, etapa.nome, []);
            
            contentDiv.innerText = material;
            
            // Salva o material gerado na trilha em mem√≥ria e no LocalStorage
            etapa.material = material;
            saveTrilhaToPersistence(trilha, currentUser.currentTrilhaIndex); 
        }

        function loadPreDefinedRoadmap(courseString) {
            try {
                const course = JSON.parse(courseString);
                
                const novaTrilha = {
                    tema: course.tema,
                    nivel: course.nivel,
                    objetivo: course.objetivo,
                    etapas: course.etapas
                };
                
                // Adiciona a trilha na lista e a define como ativa
                currentUser.trilhas.push(novaTrilha);
                currentUser.currentTrilhaIndex = currentUser.trilhas.length - 1; 
                saveUserTrilhas(); // Salva no LocalStorage
                
                loadRoadmap(novaTrilha);

            } catch (e) {
                alert("Erro ao carregar o curso pr√©-definido.");
                console.error("Erro ao parsear curso pr√©-definido:", e);
                showGeneratorView();
            }
        }

        async function gerarRoadmap() {
            const tema = document.getElementById('inputTema').value.trim();
            const nivel = document.getElementById('inputNivel').value;
            const objetivo = document.getElementById('inputObjetivo').value.trim();
            
            // Captura o novo campo de refer√™ncia
            const materialReferencia = document.getElementById('inputReferencia').value.trim();
            
            const loadingModal = document.getElementById('loadingModal');
            
            if (!tema || !nivel || !objetivo) {
                alert("Por favor, preencha o Tema, N√≠vel e Objetivo para gerar o roadmap.");
                return;
            }
            
            loadingModal.style.display = 'flex';
            
            try {
                // Comando de gera√ß√£o para a API Groq
                let prompt = `Gere uma trilha de aprendizado detalhada sobre o tema: ${tema}, para o n√≠vel: ${nivel}. O objetivo √©: ${objetivo}.`;
                
                // Adiciona a refer√™ncia ao prompt, se existir
                if (materialReferencia) {
                    prompt += ` Use estes materiais de refer√™ncia/contexto para guiar a estrutura e o conte√∫do sugerido, se aplic√°vel: ${materialReferencia}.`;
                }

                prompt += ` A resposta deve ser um JSON v√°lido no seguinte formato: { "tema": "${tema}", "nivel": "${nivel}", "objetivo": "${objetivo}", "etapas": [ { "nome": "Nome da Etapa 1", "status": "pendente", "material": "" }, ... ] }`;


                const response = await fetch(GROQ_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: MODEL_NAME,
                        messages: [{ role: "user", content: prompt }],
                        temperature: 0.8,
                        max_tokens: 2000,
                    }),
                });

                if (!response.ok) {
                    throw new Error(`Erro na API Groq: ${response.statusText}`);
                }

                const data = await response.json();
                const jsonText = data.choices[0].message.content.trim();
                
                // Tenta extrair e limpar o JSON (remove ```json e ```)
                const cleanedJsonText = jsonText.substring(jsonText.indexOf('{'), jsonText.lastIndexOf('}') + 1);
                
                const novaTrilha = JSON.parse(cleanedJsonText);
                
                // Adiciona a trilha na lista e a define como ativa
                currentUser.trilhas.push(novaTrilha);
                currentUser.currentTrilhaIndex = currentUser.trilhas.length - 1; 
                saveUserTrilhas(); // Salva no LocalStorage
                
                loadRoadmap(novaTrilha);
                loadingModal.style.display = 'none';

            } catch (error) {
                console.error("Erro na API ou ao processar JSON:", error);
                loadingModal.style.display = 'none';
                alert("Ocorreu um erro ao gerar o roadmap. Tente novamente ou ajuste os detalhes.");
            }
        }
        
        // --- FUN√á√ïES DE CHATBOT ---

        function showChatView() {
            showView('chat-view');
            patolindoState.lastView = 'roadmap-view';
            updateChatStatus();
        }
        
        function updateChatStatus() {
            document.getElementById('questionsLeftDisplay').innerText = patolindoState.questionsLeft;
            const inputContainer = document.getElementById('chat-input-container');
            if (currentUser.name === 'Convidado' && patolindoState.questionsLeft <= 0) {
                inputContainer.classList.add('disabled-chat');
                document.getElementById('chat-status').style.color = 'var(--color-danger)';
                document.getElementById('chat-status').innerText = 'Limite de consultas atingido (Convidado). Clique em Sair e entre novamente para resetar.';
            } else {
                inputContainer.classList.remove('disabled-chat');
                document.getElementById('chat-status').style.color = 'var(--color-text)';
                document.getElementById('chat-status').innerText = `Consultas restantes: ${patolindoState.questionsLeft}`;
            }
        }

        async function handleChatSend() {
            const input = document.getElementById('chat-input');
            const userMessage = input.value.trim();
            if (!userMessage) return;

            const chatHistory = document.getElementById('chat-history');
            
            // Verifica se h√° trilha ativa e material gerado para contexto
            const trilha = currentUser.trilhas[currentUser.currentTrilhaIndex];
            const etapaIndex = trilha ? trilha.etapas.findIndex(e => e.material && e.material.length > 10) : -1;
            
            if (currentUser.name === 'Convidado' && patolindoState.questionsLeft <= 0) return;
            
            // Adiciona a mensagem do usu√°rio
            chatHistory.innerHTML += `<div class="chat-message message-user">${userMessage}</div>`;
            input.value = '';
            chatHistory.scrollTop = chatHistory.scrollHeight;

            // Adiciona "Digitando..."
            const typingMessage = document.createElement('div');
            typingMessage.className = 'chat-message message-patolindo';
            typingMessage.innerText = 'Patolindo est√° digitando...';
            chatHistory.appendChild(typingMessage);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            
            // 1. Constr√≥i o hist√≥rico
            const history = patolindoState.history.map(m => ({ role: m.role, content: m.content }));
            history.push({ role: "user", content: userMessage });
            
            // 2. Cria o prompt de contexto
            let materialContext = "Nenhum contexto de etapa dispon√≠vel. Responda √† pergunta do usu√°rio.";
            if (etapaIndex !== -1) {
                materialContext = trilha.etapas[etapaIndex].material.substring(0, 1000); // Limita o contexto
            }

            const systemPrompt = `Voc√™ √© o Patolindo Bot, um assistente amig√°vel e focado. Sua fun√ß√£o √© responder D√öVIDAS sobre a etapa de estudo atual. Responda de forma concisa. O contexto da etapa atual √©: "${materialContext}". A pergunta do usu√°rio √©: "${userMessage}"`;

            try {
                const response = await fetch(GROQ_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: MODEL_NAME,
                        messages: [
                            { role: "system", content: systemPrompt },
                            ...history 
                        ],
                        temperature: 0.8,
                        max_tokens: 500,
                    }),
                });

                if (!response.ok) throw new Error("Erro na API Groq.");

                const data = await response.json();
                const patolindoResponse = data.choices[0].message.content.trim();

                // 3. Remove "Digitando..." e Adiciona a resposta
                typingMessage.remove();
                chatHistory.innerHTML += `<div class="chat-message message-patolindo">${patolindoResponse}</div>`;
                chatHistory.scrollTop = chatHistory.scrollHeight;
                
                // 4. Atualiza o estado
                if (currentUser.name === 'Convidado') {
                    patolindoState.questionsLeft--;
                }
                patolindoState.history.push({ role: "user", content: userMessage });
                patolindoState.history.push({ role: "assistant", content: patolindoResponse });
                updateChatStatus();

            } catch (error) {
                typingMessage.remove();
                chatHistory.innerHTML += `<div class="chat-message message-patolindo" style="background-color: var(--color-danger); color: white;">Erro ao responder. Tente novamente.</div>`;
                console.error("Erro no chatbot:", error);
            }
        }

        // --- INICIALIZA√á√ÉO E LISTENERS ---
        document.addEventListener("DOMContentLoaded", async () => {
            
            // Tenta carregar o √∫ltimo nome de usu√°rio logado
            const lastLoggedInUser = localStorage.getItem("quackademyLastUser");
            
            if (
